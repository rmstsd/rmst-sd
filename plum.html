<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>plum</title>
    <script src="/source-code/tailwindcss.js"></script>
    <script>
      tailwind.config = {}
    </script>
  </head>

  <body class="p-3">
    <button class="border-2 p-2">ç”»</button>

    <canvas width="800" height="600" class="border-2 border-purple-900" />

    <script>
      const btn = document.querySelector('button')
      btn.onclick = () => {
        ctx.clearRect(0, 0, 800, 600)
        cancelAnimationFrame(rafId)

        setTimeout(() => {
          count = 0
          step(line)
        }, 300)
      }

      const canvas = document.querySelector('canvas')
      const ctx = canvas.getContext('2d')
      ctx.strokeStyle = '#aaa'

      const Width = 800
      const Height = 600

      const line = { start: { x: Width / 2, y: Height }, length: 20, theta: -Math.PI / 2 }

      let rafId

      step(line)

      const pendingTasks = []

      let count = 0
      async function step(line, depth = 0) {
        if (depth > 10) return

        await drawLineRaf(line)
        const end = getEndPoint(line)

        count++
        rafId = requestAnimationFrame(() => {
          if (Math.random() < 0.5 || depth < 3)
            step(
              {
                start: end,
                length: line.length, // + Math.random() * -10 + 5,
                theta: line.theta - Math.random() * 0.4
              },
              depth + 1
            )
          if (Math.random() < 0.5 || depth < 3)
            step(
              {
                start: end,
                length: line.length, // + Math.random() * -10 + 5,
                theta: line.theta + Math.random() * 0.4
              },
              depth + 1
            )
        })
      }

      function drawLineRaf(line) {
        return new Promise(resolve => {
          let total = 0
          const perLength = 3

          dd(line.start)

          function dd(start) {
            if (total === line.length) {
              resolve()
              return
            }

            total += perLength
            if (total > line.length) total = line.length

            const end = getEndPoint({ start, length: perLength, theta: line.theta })
            lineTo(start, end)

            rafId = requestAnimationFrame(() => dd(end))
          }
        })
      }

      function lineTo(start, end) {
        ctx.beginPath()
        ctx.moveTo(start.x, start.y)
        ctx.lineTo(end.x, end.y)
        ctx.stroke()
      }

      function getEndPoint(lineDesc) {
        const { start, length, theta } = lineDesc
        const end = {
          x: start.x + length * Math.cos(theta),
          y: start.y + length * Math.sin(theta)
        }
        return end
      }
    </script>
  </body>
</html>

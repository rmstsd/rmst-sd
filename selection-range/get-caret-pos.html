<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document++</title>
    <style>
      body {
        margin: 0;
      }

      .box {
        border: 2px solid #e6bde6;
        padding: 10px;
        height: 300px;
        border-radius: 5px;
        transition: 0.2s;
        margin: 0 10px;
      }

      .box:focus {
        outline: none;
        border-color: #dd15dd;
      }
    </style>
  </head>

  <body>
    <div style="margin-left: 38px; height: 20px">1</div>
    <div contenteditable class="box">
      暗示法
      <span>123</span>
      规环境监控
    </div>
  </body>

  <script>
    function getCaretPos() {
      const sel = window.getSelection()
      console.log(sel.collapseToEnd())
      // const range = sel.getRangeAt(0)
      // const { left, top, height } = range.getBoundingClientRect()
      // return { left, top, height }
    }

    window.addEventListener('mouseup', () => {
      getCaretPos()
    })

    const dom = document.querySelector('.box')

    dom.addEventListener('keyup', evt => {
      if (evt.shiftKey && evt.key === '@') {
        const { left, top, height } = getCaretPos()

        const div = document.createElement('div')
        div.style.position = 'fixed'
        div.style.top = top + 'px'
        div.style.left = left + 'px'
        div.style.height = height + 'px'
        div.style.width = 1 + 'px'
        div.style.backgroundColor = 'red'
        div.style.opacity = '0.5'

        document.body.appendChild(div)
      }
    })
  </script>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <style type="text/css">
      .rich-text {
        background-color: #fff;
        border: 2px solid #c2c8ff;
        min-height: 200px;
        outline: none;
        padding: 5px;
      }

      .rich-text hr {
        display: inline-block;
        border: 0;
        position: relative;
        margin: 0;
      }

      .rich-text hr::before {
        content: attr(user-name);
        height: 34px;
        background-color: #d1f2ff;
        border: 1px solid red;
        margin: 0 5px;
      }

      .rich-text:focus {
        border-color: #266afc;
      }

      .user-tag {
        color: #fff;
        background-color: #ff8c53;
        padding: 0 5px;
        border-radius: 999em;
        margin: 0 4px;
      }

      .wrapper {
        padding-right: 100px;
        background-color: #009ad6;
      }

      .person-container {
        position: fixed;

        box-shadow: 0 0 10px #d8d8d8;

        background-color: #fff;
        border-radius: 5px;
        padding: 5px 0;
      }

      .person-item {
        padding: 7px;
        cursor: pointer;
      }

      .person-item:hover {
        background-color: #eee;
      }

      .file-img {
        width: 20px;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <div class="rich-text" contenteditable="plaintext-only" onblur="onblurr()">
      fdghdfjgfdf

      <!-- <hr user-name="李白" /> -->
    </div>

    <button onclick="focc()">获取焦点</button>

    <div class="person-container" style="display: none">
      <div class="person-item">李白</div>
      <div class="person-item">杜甫</div>
      <div class="person-item person-item1">上官婉儿</div>
    </div>
  </body>

  <script src="./caret-pos.js"></script>
  <script type="text/javascript">
    let lastEditRange
    function focc() {
      const { range } = getSelectionAndRange()
      document.querySelector('.rich-text').focus()

      var selection = getSelection()

      if (lastEditRange) {
        selection.removeAllRanges()
        selection.addRange(lastEditRange)
      }
    }

    function onblurr() {
      const { range } = getSelectionAndRange()
      lastEditRange = range
      console.log(1)
    }

    const richTextDom = document.querySelector('.rich-text')
    const personDom = document.querySelector('.person-container')

    personDom.onmousedown = evt => {
      evt.preventDefault()
    }
    personDom.onclick = evt => {
      const { innerText } = evt.target

      // document.execCommand('delete')
      document.execCommand('delete')

      addPerson(innerText)
    }

    richTextDom.oninput = evt => {}

    richTextDom.onmousedown = evt => {
      evt.stopPropagation()
    }

    richTextDom.onkeydown = evt => {
      ;['Enter', 'ArrowUp', 'ArrowDown'].includes(evt.key) && evt.preventDefault()
      if (evt.key === 'Backspace') {
        // evt.preventDefault()
        // console.log(evt)
        // const { selection, range } = getSelectionAndRange()
        // console.log(range.startContainer)
        // console.log(range.startContainer.previousElementSibling)
      }
    }
    richTextDom.onkeyup = evt => {
      if (evt.shiftKey && evt.key === '@') {
        const { left, top } = offset(richTextDom)
        personDom.style.left = `${left}px`
        personDom.style.top = `${top + 25}px`
        personDom.style.display = null
      }
    }

    richTextDom.onpaste = evt => {
      evt.preventDefault()
      const text = evt.clipboardData.getData('text')
      const textNode = document.createTextNode(text)
      const { range, selection } = getSelectionAndRange()
      range.insertNode(textNode)
      selection.collapseToEnd()
    }

    function getSelectionAndRange() {
      const selection = window.getSelection()
      const range = selection.getRangeAt(0)
      return { selection, range }
    }

    function addPerson(name) {
      const spanWrapper = document.createElement('span')

      const spanUser = document.createElement('span')
      spanUser.setAttribute('contenteditable', false)
      spanUser.classList.add('user-tag')
      spanUser.innerText = '@' + name

      const zwnj_1 = document.createElement('span')
      zwnj_1.innerHTML = '&#8203' // 零宽空格

      const zwnj_2 = document.createElement('span')
      zwnj_2.innerHTML = '&#8203'

      spanWrapper.append(zwnj_1, spanUser, zwnj_2)

      const { range, selection } = getSelectionAndRange()

      range.insertNode(spanWrapper) //insertNode 插入后默认选中这个 `选区`
      selection.collapseToEnd() //collapse(zwnj, 1)
      // selection.collapse(zwnj, 1)

      personDom.style.display = 'none'
    }

    //
  </script>
</html>
